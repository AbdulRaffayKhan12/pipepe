name: Deploy to Apigee

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      API_NAME: reverse-pipeline1
      PROXY_NAME: apiproxy
      ORG_CONFIG_PATH: org-config.txt
      ZIP_PATH: ${{ github.workspace }}/Reverse-pipe.zip
      TEAMS_WEBHOOK: https://abacusglobal.webhook.office.com/webhookb2/...
      POSTMAN_COLLECTION_UID: 40041998-dee7eec2-5d39-49da-b172-2c535588dfc8
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Org and Env Config
        id: org-config
        run: |
          configText=$(cat "${{ env.ORG_CONFIG_PATH }}" | xargs)
          org=$(echo "$configText" | grep -o 'org=[^ ]*' | cut -d= -f2)
          envs=$(echo "$configText" | grep -o 'env=[^ ]*' | cut -d= -f2)
          if [ -z "$org" ] || [ -z "$envs" ]; then
            echo "Missing org or env entry in org-config.txt"
            exit 1
          fi
          case "$org" in
            "abacus-apigee-demo")
              provider="projects/180599253937/locations/global/workloadIdentityPools/demo-pool/providers/demo-github"
              sa="raffay-check@abacus-apigee-demo.iam.gserviceaccount.com"
              ;;
            "abacus-apigee-demo2")
              provider="projects/738158130399/locations/global/workloadIdentityPools/demo2-pool/providers/demo2-github"
              sa="raffay-cicd@abacus-apigee-demo2.iam.gserviceaccount.com"
              ;;
            *)
              echo "Unsupported org: $org"
              exit 1
              ;;
          esac
          echo "APIGEE_ORG=$org" >> $GITHUB_ENV
          echo "APIGEE_ENVS=$envs" >> $GITHUB_ENV
          echo "WIF_PROVIDER=$provider" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT=$sa" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          token_format: "access_token"
          export_environment_variables: false

      # ✅ Cache node_modules (for Newman)
      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Newman + Reporters
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install newman newman-reporter-htmlextra

      - name: Zip Proxy
        run: |
          zip -r "${{ env.ZIP_PATH }}" apiproxy

      - name: Import Apigee Proxy
        id: import-proxy
        run: |
          org=$APIGEE_ORG
          zipFile=$ZIP_PATH
          token="${{ steps.auth.outputs.access_token }}"
          importResponseFile="${{ github.workspace }}/import_response.json"
          curl -s -X POST "https://apigee.googleapis.com/v1/organizations/$org/apis?action=import&name=$API_NAME" \
            -H "Authorization: Bearer $token" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$zipFile" \
            -o "$importResponseFile"
          revision=$(jq -r '.revision' "$importResponseFile")
          echo "APIGEE_REVISION=$revision" >> $GITHUB_ENV

      - name: Deploy Apigee Proxy
        run: |
          org=$APIGEE_ORG
          revision=$APIGEE_REVISION
          token="${{ steps.auth.outputs.access_token }}"
          envList=$(echo $APIGEE_ENVS | tr ',' ' ')
          results="[]"
          for envName in $envList; do
            echo "Deploying revision $revision to $envName..."
            curl -s -X POST "https://apigee.googleapis.com/v1/organizations/$org/environments/$envName/apis/$API_NAME/revisions/$revision/deployments?override=true" \
              -H "Authorization: Bearer $token" >/dev/null
            results=$(echo $results | jq ". += [{\"Proxy\":\"$API_NAME\",\"Environment\":\"$envName\",\"Revision\":\"$revision\",\"Organization\":\"$org\"}]")
          done
          echo "$results" > "${{ github.workspace }}/deploy_results.json"

      # ⏳ Wait until deployment is ready (max 90s)
      - name: Wait for Deployment Ready
        run: |
          org=$APIGEE_ORG
          token="${{ steps.auth.outputs.access_token }}"
          revision=$APIGEE_REVISION
          envList=$(echo $APIGEE_ENVS | tr ',' ' ')
          for envName in $envList; do
            echo "Checking deployment status in $envName..."
            for i in {1..18}; do  # 18 * 5s = 90s
              sleep 5
              deployments=$(curl -s -H "Authorization: Bearer $token" \
                "https://apigee.googleapis.com/v1/organizations/$org/environments/$envName/apis/$API_NAME/deployments")
              deployed=$(echo "$deployments" | jq -r ".deployments[]?.revision" | grep -w "$revision" || true)
              if [ -n "$deployed" ]; then
                echo "✅ Revision $revision is deployed in $envName"
                break
              fi
              if [ "$i" -eq 18 ]; then
                echo "❌ Deployment did not become ready in $envName within 90s"
                exit 1
              fi
            done
          done

      - name: Run Newman Tests
        id: newman
        run: |
          mkdir -p newman
          npx newman run "https://api.getpostman.com/collections/${{ env.POSTMAN_COLLECTION_UID }}?apikey=${{ env.POSTMAN_API_KEY }}" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export newman/newman-report.html \
            --reporter-junit-export newman/newman-report.xml
        continue-on-error: true

      - name: Rollback if Tests Fail
        if: steps.newman.outcome == 'failure'
        run: |
          org=$APIGEE_ORG
          token="${{ steps.auth.outputs.access_token }}"
          revision=$APIGEE_REVISION
          envList=$(echo $APIGEE_ENVS | tr ',' ' ')
          rollbackResults="[]"
          for envName in $envList; do
            echo "Looking for previous revision in $envName..."
            deployments=$(curl -s -H "Authorization: Bearer $token" \
              "https://apigee.googleapis.com/v1/organizations/$org/environments/$envName/apis/$API_NAME/deployments")
            prev=$(echo "$deployments" | jq -r ".deployments[]?.revision" | sort -nr | grep -v "$revision" | head -n 1)
            if [ -n "$prev" ]; then
              echo "⚠️ Tests failed. Rolling back $envName to revision $prev"
              curl -s -X POST "https://apigee.googleapis.com/v1/organizations/$org/environments/$envName/apis/$API_NAME/revisions/$prev/deployments?override=true" \
                -H "Authorization: Bearer $token" >/dev/null
              rollbackResults=$(echo $rollbackResults | jq ". += [{\"Proxy\":\"$API_NAME\",\"Environment\":\"$envName\",\"RolledBackTo\":\"$prev\",\"Organization\":\"$org\"}]")
            else
              echo "⚠️ No previous revision found to roll back in $envName"
            fi
          done
          echo "$rollbackResults" > "${{ github.workspace }}/rollback_results.json"
          exit 1

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-test-reports
          path: newman/

      - name: Send Teams Notification
        if: always()
        run: |
          if [ -s "${{ github.workspace }}/rollback_results.json" ]; then
            results=$(cat "${{ github.workspace }}/rollback_results.json")
            rows=""
            for row in $(echo "$results" | jq -c '.[]'); do
              proxy=$(echo $row | jq -r '.Proxy')
              env=$(echo $row | jq -r '.Environment')
              rev=$(echo $row | jq -r '.RolledBackTo')
              org=$(echo $row | jq -r '.Organization')
              rows="$rows<tr><td>$proxy</td><td>$env</td><td>$rev</td><td>$org</td></tr>"
            done
            htmlTable="<table border='1'><tr><th>API Proxy</th><th>Environment</th><th>Rolled Back To</th><th>Organization</th></tr>$rows</table>"
            payload="{\"title\": \"Apigee Rollback Notification\", \"text\": \"Tests failed. Proxy was rolled back.<br>$htmlTable\"}"
          elif [ -s "${{ github.workspace }}/deploy_results.json" ]; then
            results=$(cat "${{ github.workspace }}/deploy_results.json")
            rows=""
            for row in $(echo "$results" | jq -c '.[]'); do
              proxy=$(echo $row | jq -r '.Proxy')
              env=$(echo $row | jq -r '.Environment')
              rev=$(echo $row | jq -r '.Revision')
              org=$(echo $row | jq -r '.Organization')
              rows="$rows<tr><td>$proxy</td><td>$env</td><td>$rev</td><td>$org</td></tr>"
            done
            htmlTable="<table border='1'><tr><th>API Proxy</th><th>Environment</th><th>Revision</th><th>Organization</th></tr>$rows</table>"
            payload="{\"title\": \"Apigee Deployment Notification\", \"text\": \"Deployment completed.<br>$htmlTable\"}"
          else
            payload="{\"title\": \"Apigee Deployment Notification\", \"text\": \"Deployment failed for API Proxy: $API_NAME (Org: $APIGEE_ORG)\"}"
          fi
          curl -H "Content-Type: application/json" -d "$payload" $TEAMS_WEBHOOK
